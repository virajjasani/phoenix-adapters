#! /usr/bin/env bash
#
#/**
# * Licensed to the Apache Software Foundation (ASF) under one
# * or more contributor license agreements.  See the NOTICE file
# * distributed with this work for additional information
# * regarding copyright ownership.  The ASF licenses this file
# * to you under the Apache License, Version 2.0 (the
# * "License"); you may not use this file except in compliance
# * with the License.  You may obtain a copy of the License at
# *
# *     http://www.apache.org/licenses/LICENSE-2.0
# *
# * Unless required by applicable law or agreed to in writing, software
# * distributed under the License is distributed on an "AS IS" BASIS,
# * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# * See the License for the specific language governing permissions and
# * limitations under the License.
# */
#
# Environment Variables:
#
#   JAVA_HOME               The java implementation to use.  Overrides JAVA_HOME.
#
#   PHOENIX_REST_HEAPSIZE   The maximum amount of heap to use.
#                           Default is unset and uses the JVMs default setting
#                           (usually 1/4th of the available memory).
#
#   PHOENIX_REST_OPTS       Extra Java runtime options.


bin=`dirname "$0"`
bin=`cd "$bin">/dev/null; pwd`

read -d '' options_string << EOF
Options:
  --config DIR         Configuration direction to use. Default: ./conf
  --help or -h         Print this help message
EOF

show_usage() {
  echo "Usage: phoenix-shim [<options>] <command> [<args>]"
  echo "$options_string"
  echo ""
  echo "Commands:"
  echo "Some commands take arguments. Pass no args or -h for usage."
  echo "  CLASSNAME        Run the class named CLASSNAME"
}

if [ "--help" = "$1" ] || [ "-h" = "$1" ]; then
  show_usage
  exit 0
fi

# This will set PHOENIX_SHIM_HOME, etc.
. "$bin"/shim-config.sh

# if no args specified, show usage
if [ $# = 0 ]; then
  show_usage
  exit 1
fi

# get arguments
COMMAND=$1
shift

JAVA=$JAVA_HOME/bin/java

# establish a default value for PHOENIX_REST_OPTS if it's not already set. For now,
# all we set is the garbage collector.
if [ -z "${PHOENIX_REST_OPTS}" ] ; then
  PHOENIX_REST_OPTS="-XX:+UseG1GC"
  export PHOENIX_REST_OPTS
fi

add_size_suffix() {
    # add an 'm' suffix if the argument is missing one, otherwise use whats there
    local val="$1"
    local lastchar=${val: -1}
    if [[ "mMgG" == *$lastchar* ]]; then
        echo $val
    else
        echo ${val}m
    fi
}

if [[ -n "$PHOENIX_REST_HEAPSIZE" ]]; then
    JAVA_HEAP_MAX="-Xmx$(add_size_suffix $PHOENIX_REST_HEAPSIZE)"
fi

if [[ -n "$PHOENIX_REST_OFFHEAPSIZE" ]]; then
    JAVA_OFFHEAP_MAX="-XX:MaxDirectMemorySize=$(add_size_suffix $PHOENIX_REST_OFFHEAPSIZE)"
fi

# so that filenames w/ spaces are handled correctly in loops below
ORIG_IFS=$IFS
IFS=

CLASSPATH=${CLASSPATH}:$JAVA_HOME/lib/tools.jar

add_to_cp_if_exists() {
  if [ -d "$@" ]; then
    CLASSPATH=${CLASSPATH}:"$@"
  fi
}

REST_CLASSPATH=""
if [ "$COMMAND" = "rest" ] ; then
  REST_CLASSPATH="${PHOENIX_SHIM_HOME}/phoenix-ddb-rest/target/*"
fi

function append_path() {
  if [ -z "$1" ]; then
    echo "$2"
  else
    echo "$1:$2"
  fi
}

JAVA_PLATFORM=""

# restore ordinary behaviour
unset IFS

# figure out which class to run
if [ "$COMMAND" = "rest" ] ; then
  CLASS='org.apache.phoenix.ddb.rest.RESTServer'
  if [ "$1" != "stop" ] ; then
    PHOENIX_REST_OPTS="$PHOENIX_REST_OPTS $PHOENIX_DDB_REST_OPTS"
  fi
fi

if [ "x$JAVA_LIBRARY_PATH" != "x" ]; then
  PHOENIX_REST_OPTS="$PHOENIX_REST_OPTS -Djava.library.path=$JAVA_LIBRARY_PATH"
  export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:$JAVA_LIBRARY_PATH"
fi

HEAP_SETTINGS="$JAVA_HEAP_MAX $JAVA_OFFHEAP_MAX"

CLASSPATH=${CLASSPATH}:${REST_CLASSPATH}

export CLASSPATH

echo "classpath=${CLASSPATH}" >&2
PHOENIX_REST_OPTS="${PHOENIX_REST_OPTS} -Xdiag"
echo "PHOENIX_REST_OPTS=${PHOENIX_REST_OPTS}"

CMD_ARGS=("$@")

export JVM_PID="$$"
exec "$JAVA" -Dproc_$COMMAND -XX:OnOutOfMemoryError="kill -9 %p" $HEAP_SETTINGS $PHOENIX_REST_OPTS $CLASS "${CMD_ARGS[@]}"
